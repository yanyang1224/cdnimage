<h2 id="takne">OCR识别服务时序图（发票、箱单）</h2>

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1718961358305-735d94f6-492b-437a-9843-ff45edffd721.jpeg)

<h3 id="h6eE2">可优化点：</h3>
1. quertz任务没有界面化
2. 轮询调用耗费资源，可以改为消息监听
3. Thread轮询在iis部署时如果没有访问进程休眠，轮询无效；
    1. 进程池可设置alwaysruning，其它监听方式也会遇到类似问题



<h2 id="ixuxW">归类相关图</h2>
<h3 id="kRJhM">检查归类并申请</h3>
+  GetProductClassifyResult--判断是否存在产品信息
+  CheckAndSaveInfo -- 判断是否存在产品，如果没有给到关务归类，如果有直接返回结果

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1721617714564-f20288e9-bc5a-49fc-8cfa-8d6d59a9960b.jpeg)

 

<h3 id="dFdsV">ERP进口归类返填</h3>
![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1721635716308-9c48a23b-eb41-4408-a311-25568ad39ca8.jpeg)



<h3 id="vQayR">ERP进口合同生成归类</h3>
![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1721645129862-0152d4d4-bfb1-47a5-a28c-c7269e2f7937.jpeg)



<h3 id="iOyiY">ERP进口合同关税信息</h3>
![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1721645254004-2ce8f2b8-a7c0-4bb0-8655-6dfddbeede26.jpeg)



<h3 id="mc7Na"> ERP进口合同刷新确认要素  </h3>
![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1721634303791-5665a0c7-3d16-4881-93d2-ca5334fb92b5.jpeg)

<h3 id="g5Uhz">关键方法</h3>
```csharp
/// <summary>
/// 判断合同是否需要生成归类
/// </summary>
/// <returns></returns>
public DataTable GetNeedRefreshClassfy()
{
    string strSQL1 = @"
                SELECT a.hkout_id
                FROM dbo.a_hkout a with(nolock)
                INNER JOIN dbo.Customer b with(nolock) ON a.Customer=b.Cusname
                WHERE documentLock =0 and IsClassify =0
                    AND In_date >='2020-05-10'";
    return this.BaseRepository("DB_CBSCS").FindTable(strSQL1);
}
```

```csharp
/// <summary>
/// 是否已申请归类
/// </summary>
/// <param name="customer"></param>
/// <param name="brand"></param>
/// <param name="model1"></param>
/// <returns></returns>
public bool IsSendClassfy(string customer, string brand, string model1)
{
    string sql = @"
        SELECT count(1) c FROM dbo.QP_Classify A with(nolock)
            INNER JOIN dbo.Customer B WITH(nolock) ON A.cusname = B.Cusname
        LEFT JOIN  DB_Customs..Biz_TransitCustomers C ON C.Customer = '{0}' AND C.ShareApplyClassifyMark=1 AND C.EnabledMark=1 AND C.LockMark=1
        WHERE ((ISNULL(C.TransitCustomer,'')='' and a.cusname = '{0}') OR  C.TransitCustomerName= B.Company) AND (brand  = '{1}' or ApplyBrand  = '{1}') AND Midcom = '{2}' AND a.IsEnable=1";
    sql = string.Format(sql, customer, brand, model1);
    var obj = this.BaseRepository("DB_CBSCS").FindObject(sql);
    return obj != null && Convert.ToInt32(obj.ToString()) > 0;
}
```



关键存储过程

```sql
[P_QP_Pre_Classify_New] -- 根据订单Id和申请编号生成归类申请
[P_QP_Pre_Classify_Hkout] -- 根据合同Id和申请编号生成归类申请
[Get_ClassifyNo] -- 获取归类申请的编号
P_QP_SetTaxRate  -- 更新合同订单的关税率
P_QP_CalcTax  -- 计算合同订单的关税
```

A_Order_M的IsClassify类型标识：

 -5 商务未锁、-4关务未锁、-3 客户未确认、-2 未生成归类、-1 归类匹配中

<h2 id="NOqEu">入仓号生成归类方案</h2>
DB_Customs..Biz_PreClassify 表的 ExternalPlat 增加类型  `<font style="color:#DF2A3F;">InWarehouseNo</font>`

QP_ApplySummaryInfo、QP_Classify的 Source 字段增加来源 `入仓号`，QP_ApplySummaryInfo增加字段 `入仓号 InputRnd`和InWarehouseNoId；QP_Classify增加字段BusinessDetailId

IE_InWarehouseNo_BusinessDetail 增加`IsClassify`，参照 a_order_m 的 isClassify

根据品牌、型号查看是否已归类（QP_Classify isenable=1）

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1721702901840-4a9f1d9d-6155-4885-85a2-32d9897a9fcc.jpeg)



<h2 id="Owdv4">进口重构数据流图（0层DFD）</h2>
![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/22068455/1720599215509-c084a702-28d2-46b3-a649-b3611c79c2fa.jpeg)





<h2 id="b3mmB">Tab_import_m_data 数据来源</h2>
DB_Service..CMsg

```sql
INSERT Tab_Import_m_data
SELECT a.*
FROM V_Import_m_new a
    LEFT JOIN Tab_Import_m_data b WITH (NOLOCK)
        ON b.HKout_m_id = a.HKout_m_id
WHERE a.In_date >= DATEADD(MONTH, -3, GETDATE())
      AND ISNULL(b.HKout_m_id, 0) = 0
      AND a.szconfirm = 1;
```

